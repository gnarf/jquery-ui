<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1">
	<title>Grid: Editing, Todo app</title>
	<link rel="stylesheet" href="../themes/base/jquery.ui.all.css">
	<link rel="stylesheet" href="../demos/demos.css">
	<script src="../jquery-1.6.2.js"></script>
	<script src="../external/jquery.tmpl.js"></script>
	<script src="../ui/jquery.ui.core.js"></script>
	<script src="../ui/jquery.ui.widget.js"></script>
	<script src="../ui/jquery.ui.button.js"></script>
	<script src="../ui/jquery.ui.observable.js"></script>
	<script src="localstore.js"></script>
	<script>

	$(function() {
		var store = $.demos.localstore( {
			key: "grid-editing-todos",
			initial: []
		});
		var todos = store.load();

		$( ":submit" ).button();

		// TODO Move this dynamic bind/unbind into a data-binder helper component.
		function bindChange( items ) {
			var that = this;
			$.each( items, function( index, item ) {
				// TODO make namespace specific for this instance
				$.observable( item ).bind( "change.todo", function() {
					deferredSaveAndRender();
				});
			});
		};

		// TODO Move this dynamic bind/unbind into a data-binder helper component.
		function unbindChange( items ) {
			$.each( items, function( index, item ) {
				// TODO see above
				$.observable( item ).unbind( "change.todo" );
			});
		};

		// TODO I am imagining something like this on $.observable:
		// The idea being we only want to use one setTimeout, and just call a bucket of functions
		// also - there are some benifits to using $.Callbacks in 1.7 instead of $.Deferred
		// but we can tackle those after 1.7 is released :) - Corey
		var changeDeferred;
		function afterChanges( fn ) {
			if ( !changeDeferred ) {

				// create a new deferred, and attach it to resolve on the "next tick"
				changeDeferred = $.Deferred();
				setTimeout(function(){
					changeDeferred.resolve();
					changeDeferred = false;
				}, 0);
			}

			// add the passed function to the callbacks bucket
			changeDeferred.done( fn );
		}

		function saveAndRender() {
			store.save();
			renderList();
		}

		// TODO once we upgrade to using $.Callbacks("unique once memory") instead of $.Deferred,
		// we don't need to do this "did i already add this function" check, the unique flag
		// on the $.Callbacks would let us just afterChanges( saveAndRender ) and only one copy
		// of saveAndRender is ever allowed on the callback bucket
		var queuedSaveAndRender;
		function deferredSaveAndRender() {
			if (!queuedSaveAndRender) {
				afterChanges(function() {
					saveAndRender();
					queuedSaveAndRender = false;
				});
				queuedSaveAndRender = true;
			}
		}

		// TODO rewrite to do incremental rendering on each todo item
		$.observable( todos ).bind("insert remove replaceAll", function( event, ui ) {
			// TODO Move this dynamic bind/unbind into a data-binder helper component.
			if ( event.type === "insert" ) {
				bindChange( ui.items );
			} else if (event.type === "replaceAll" ) {
				unbindChange( ui.oldItems );
				bindChange( ui.newItems );
			} else {
				unbindChange( ui.items );
			}
			deferredSaveAndRender();
		});

		function renderList() {
			updateAllChecked();
			$( "#remaining" ).text( todos.length + (todos.length === 1 ? " item" : " items") + " remaining" );
			list.empty().append( $( "#todo-list-item" ).tmpl( todos ) );
		}
		function update( index, checked ) {
			$.observable(todos[ index ]).property("done", checked);
			updateAllChecked();
			store.save();
		}
		function updateAllChecked() {
			var allChecked = todos.length && $.grep( todos, function( item, index ) {
				return !item.done
			} ).length == 0;
			$( "#markDone" ).find( "input" ).attr( "checked", allChecked );
		}

		$( "#newTodo" ).submit(function( event ) {
			event.preventDefault();
			var input = $( this ).find( "input" );
			if ( !input.val() ) {
				return;
			}
			$.observable( todos ).insert({
				id: todos.length + 1,
				title: input.val()
			});
			input.val( "" );
		});

		var list = $( "#todos-list" ).delegate( "input", "click", function( event ) {
			var checked = $( this ).is( ":checked" );
			var li = $( this ).closest( "li" ).toggleClass( "done", checked );
			update( li.index(), checked );
		});
		$( "#markDone" ).click(function() {
			var checkbox = $( this ).find( "input" );
			// need to wait for checked state to change, inconsistent within click event handler
			setTimeout(function() {
				var check = checkbox.is( ":checked" );
				$.each( todos, function( index, todo ) {
					$.observable(todo).property("done", check);
				});
			}, 1);
		});
		$( "#clearCompleted" ).click( function() {
			for ( var i = todos.length - 1; i >= 0; i-- ) {
				if ( todos[ i ].done ) {
					$.observable(todos).remove( i );
				}
			}
		});
		renderList();
	});
	</script>
	<style>
		#app { min-width: 200px; max-width: 600px; margin: auto; margin-top: 2em;  }
		h1, h2 { padding: .5em; margin: 0; position: relative; }
		#newTodo { padding: .6em; margin: 0; }
		#newTodo input {
			font-size: 1.5em; padding: 0.5em; border: 1px solid #999; box-shadow: 0 0 6px rgba(0,0,0,0.5);
			display: block; width: 100%; box-sizing: border-box; -ms-box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box;
		}
		#overview { position: relative; padding: 1.2em; background: #eee; border: 1px solid #999; border-left: none; border-right: none; }
		#clearCompleted { position: absolute; right: 1em; top: 0.5em; }
		#markDone { padding: 0.5em; }
		#todos-list { margin: 0; list-style: none; padding-left: 0; }
		#todos-list label { padding: 0.5em; width: 100%; display: inline-block; }
		#todos-list .done label { text-decoration: line-through; color: #666; }
		#todos-list li:nth-child(odd) { background-color: #eee };
	</style>
</head>
<body>

<div id="app">
	<h1 class="ui-widget-header ui-corner-top">
		Todos
	</h1>
	<div class="ui-widget ui-widget-content ui-corner-bottom">
		<form id="newTodo">
			<input placeholder="What needs to be done?" class="ui-corner-all" />
		</form>
		<div id="overview">
			<span id="remaining">0 items remaining.</span>
			<button id="clearCompleted">Clear Completed</button>
		</div>
		<div id="markDone">
			<label>
				<input type="checkbox" />
				Mark All as Done
			</label>
		</div>
		<ul id="todos-list">
		</ul>
	</div>

</div>

<script id="todo-list-item" type="text/x-jquery-tmpl">
	<li {{if done}}class="done"{{/if}}>
		<label>
			<input type="checkbox" id="todo-${id}" {{if done}}checked="checked"{{/if}} />
			${title}
		</label>
	</li>
</script>

</body>
</html>
